<!DOCTYPE html>
<html>
<head>
    <title>F1 Nebula - Race Control</title>
    <script src="/socket.io/socket.io.js"></script> 
    <style>
        body { margin: 0; overflow: hidden; background: #1a5e1a; font-family: 'Arial Black', sans-serif; }
        canvas { display: block; }
        #overlay { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; }
        button { padding: 20px 40px; font-size: 30px; background: #fbff00; border: none; cursor: pointer; font-family: 'Arial Black'; border-radius: 10px; transition: 0.2s; margin: 10px; }
        button:hover { background: #fffb00; transform: scale(1.05); }
        .car-selector { display: flex; gap: 10px; margin: 15px 0; }
        .car-card { background: rgba(255,255,255,0.1); border: 2px solid #555; padding: 10px; border-radius: 8px; cursor: pointer; color: white; font-size: 11px; width: 105px; text-align: center; }
        .car-card.selected { border-color: #fbff00; background: rgba(252, 255, 0, 0.3); }
        #map-selector { background: rgba(0,0,0,0.8); border: 2px solid #fbff00; padding: 15px; border-radius: 10px; color: white; margin: 15px; display: flex; align-items: center; gap: 20px; }
        .map-btn { background: #fbff00; border: none; padding: 5px 15px; font-weight: bold; cursor: pointer; border-radius: 5px; }
        .map-btn:disabled { background: #444; cursor: not-allowed; }
        #lights-container { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); display: none; z-index: 150; }
        .light { width: 60px; height: 60px; border-radius: 50%; margin: 5px; background: #111; }
        .red { background: #ff0000; box-shadow: 0 0 30px #ff0000; }
        .yellow { background: #ffcc00; box-shadow: 0 0 30px #ffcc00; }
        .green { background: #00ff00; box-shadow: 0 0 30px #00ff00; }
        #nitro-container { position: absolute; bottom: 170px; left: 50%; transform: translateX(-50%); width: 200px; height: 12px; background: #333; border: 2px solid #fbff00; border-radius: 10px; display: none; overflow: hidden; }
        #nitro-bar { width: 100%; height: 100%; background: #00ccff; }
        #dashboard { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 220px; height: 120px; background: rgba(0,0,0,0.9); border-radius: 110px 110px 15px 15px; border: 4px solid #fbff00; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; padding-bottom: 10px; }
        #speed-num { color: #fbff00; font-size: 40px; font-family: 'Courier New'; }
    </style>
</head>
<body>
<div id="overlay">
    <div id="menu-login"><input type="text" id="room-input" placeholder="CÓDIGO SALA" maxlength="4" style="padding:15px; font-size:24px; text-align:center;"><button onclick="joinLobby()">CONECTAR</button></div>
    <div id="menu-lobby" style="display:none; text-align:center;">
        <h2 id="display-room-name" style="color:#fbff00;">SALA: ----</h2>
        <div class="car-selector">
            <div class="car-card selected" onclick="selectCar('balanceado', this)"><h4>NEBULA</h4><p>Normal</p></div>
            <div class="car-card" onclick="selectCar('acelerador', this)"><h4>SPRINTER</h4><p>Acel++</p></div>
            <div class="car-card" onclick="selectCar('offroad', this)"><h4>RALLY</h4><p>Manejo 4</p></div>
            <div class="car-card" onclick="selectCar('veloz', this)"><h4>SONIC</h4><p>Nitro 400</p></div>
        </div>
        <div id="map-selector">
            <button id="prevMap" class="map-btn" onclick="changeMap(-1)" disabled><</button>
            <div>MAPA: <span id="map-name" style="color:#fbff00">PRADERA CLÁSICA</span><br><small id="host-msg">(Solo Host)</small></div>
            <button id="nextMap" class="map-btn" onclick="changeMap(1)" disabled>></button>
        </div>
        <button id="ready-btn" onclick="toggleReady()">¡LISTO!</button>
    </div>
</div>
<div id="lights-container" style="display:none; flex-direction: row;"><div id="light-r" class="light"></div><div id="light-y" class="light"></div><div id="light-g" class="light"></div></div>
<div id="nitro-container"><div id="nitro-bar"></div></div>
<div id="dashboard"><div id="speed-num">0</div><div style="color:white; font-size:10px;">KM/H</div></div>
<canvas id="gameCanvas"></canvas>

<script>
    const socket = io();
    let currentRoom = "", otherPlayers = {}, playerNumber = "?", isReady = false, currentMapIndex = 0;
    const MAPS = [
        { name: "PRADERA CLÁSICA", w: 6000, h: 4000, r: 800 },
        { name: "ÓVALO VELOZ", w: 8000, h: 2500, r: 1200 },
        { name: "SERPIENTE TÉCNICA", w: 4000, h: 6000, r: 400 },
        { name: "CIRCUITO URBANO", w: 5000, h: 5000, r: 100 }
    ];
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let motorOsc = null, nitroOsc = null, particles = [], sonicNitroTime = 0, sonicCooldown = 0;
    const NITRO_DURATION = 4, NITRO_COOLDOWN = 15;

    const CAR_TYPES = {
        balanceado: { top: 32, accel: 1.2, grassMax: 10.0, color: "#fbff00", grip: 0.15 },
        acelerador: { top: 25, accel: 6.0, grassMax: 10.0, color: "#00ccff", grip: 0.15 },
        offroad:    { top: 32, accel: 1.2, grassMax: 20.0, color: "#44ff44", grip: 0.20 },
        veloz:      { top: 32, accel: 0.12, grassMax: 5.0, color: "#ff4444", grip: 0.15 }
    };
    let selectedCarType = "balanceado";

    function selectCar(type, element) {
        selectedCarType = type;
        document.querySelectorAll('.car-card').forEach(c => c.classList.remove('selected'));
        element.classList.add('selected');
        player.color = CAR_TYPES[type].color;
        document.getElementById('nitro-container').style.display = (type === 'veloz') ? 'block' : 'none';
    }

    function changeMap(dir) {
        currentMapIndex = (currentMapIndex + dir + MAPS.length) % MAPS.length;
        socket.emit('change-map-request', { room: currentRoom, mapIndex: currentMapIndex });
    }

    function joinLobby() {
        const input = document.getElementById('room-input');
        if (input.value.length === 4) {
            currentRoom = input.value.toUpperCase();
            document.getElementById('menu-login').style.display = 'none';
            document.getElementById('menu-lobby').style.display = 'block';
            document.getElementById('display-room-name').innerText = "SALA: " + currentRoom;
            socket.emit('join-room', currentRoom);
        }
    }

    function toggleReady() { isReady = !isReady; socket.emit('toggle-ready', currentRoom); }

    socket.on('init-player', (data) => { 
        playerNumber = data.num;
        if(playerNumber == 1) {
            document.getElementById('prevMap').disabled = false;
            document.getElementById('nextMap').disabled = false;
            document.getElementById('host-msg').innerText = "HOST";
        }
    });

    socket.on('map-changed', (idx) => {
        currentMapIndex = idx;
        document.getElementById('map-name').innerText = MAPS[idx].name;
    });

    socket.on('begin-countdown', () => startRaceLocal());
    socket.on('player-moved', (data) => { otherPlayers[data.id] = data; });

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let raceStarted = false, canMove = false;
    let player = { x: 1200, y: 1000, angle: 0, velX: 0, velY: 0, speed: 0, color: "#fbff00" };
    const keys = {};

    function startRaceLocal() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('lights-container').style.display = 'flex';
        player.x = 1200 + (playerNumber * 120); player.y = 1000;
        canMove = true; raceStarted = true;
        setTimeout(() => document.getElementById('light-r').classList.add('red'), 500);
        setTimeout(() => document.getElementById('light-y').classList.add('yellow'), 1500);
        setTimeout(() => document.getElementById('light-g').classList.add('green'), 2500);
        setTimeout(() => document.getElementById('lights-container').style.display = 'none', 5000);
    }

    function trackPath(c, s = 1) {
        const m = MAPS[currentMapIndex];
        const x = 1000*s, y = 1000*s, w = m.w*s, h = m.h*s, r = m.r*s;
        c.beginPath(); c.moveTo(x + r, y); c.lineTo(x + w - r, y);
        c.quadraticCurveTo(x + w, y, x + w, y + r); c.lineTo(x + w, y + h - r);
        c.quadraticCurveTo(x + w, y + h, x + w - r, y + h); c.lineTo(x + r, y + h);
        c.quadraticCurveTo(x, y + h, x, y + h - r); c.lineTo(x, y + r);
        c.quadraticCurveTo(x, y, x + r, y); c.closePath();
    }

    function update() {
        if (raceStarted) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            ctx.lineWidth = 600; trackPath(ctx);
            let onGrass = !ctx.isPointInStroke(player.x, player.y);

            let inX = 0, inY = 0;
            if (canMove) {
                if (keys['w'] || keys['ArrowUp']) inY -= 1;
                if (keys['s'] || keys['ArrowDown']) inY += 1;
                if (keys['a'] || keys['ArrowLeft']) inX -= 1;
                if (keys['d'] || keys['ArrowRight']) inX += 1;
                if (keys[' '] && selectedCarType === 'veloz' && sonicCooldown <= 0 && player.speed > 20) {
                    sonicNitroTime = NITRO_DURATION; sonicCooldown = NITRO_COOLDOWN;
                    if (player.speed < 32) { // Salto a 320 km/h
                        let ratio = 32 / player.speed;
                        player.velX *= ratio; player.velY *= ratio; player.speed = 32;
                    }
                }
            }
            if (inX !== 0 || inY !== 0) { let mag = Math.sqrt(inX*inX + inY*inY); inX /= mag; inY /= mag; }

            let stats = Object.assign({}, CAR_TYPES[selectedCarType]);
            let currentGrip = stats.grip;

            if (selectedCarType === 'veloz') {
                if (sonicNitroTime > 0) {
                    sonicNitroTime -= 1/60; stats.top = 40; 
                    currentGrip = 0.09; // Manejo -40% (0.15 -> 0.09)
                    if(!nitroOsc) playNitroSound(true);
                    particles.push({x: player.x, y: player.y, r: 10+Math.random()*15, life: 1, c: Math.random() > 0.5 ? "#ffaa00" : "#555"});
                } else { playNitroSound(false); if (sonicCooldown > 0) sonicCooldown -= 1/60; }
                document.getElementById('nitro-bar').style.width = ((NITRO_COOLDOWN - sonicCooldown) / NITRO_COOLDOWN * 100) + "%";
            }

            if (!motorOsc) playEngineSound(50);
            motorOsc.frequency.setTargetAtTime(50 + (player.speed * 4), audioCtx.currentTime, 0.1);

            let targetMax = onGrass ? stats.grassMax : stats.top; 
            let friction = (selectedCarType === 'veloz') ? 0.9995 : 0.992;
            let accel = onGrass ? 0.3 : stats.accel;

            player.velX += inX * accel; player.velY += inY * accel;
            player.velX *= friction; player.velY *= friction;
            player.speed = Math.sqrt(player.velX**2 + player.velY**2);
            if (player.speed > targetMax) { player.velX *= (targetMax/player.speed); player.velY *= (targetMax/player.speed); }

            player.x += player.velX; player.y += player.velY;
            if (player.speed > 0.2) {
                let targetA = Math.atan2(player.velY, player.velX);
                let diff = targetA - player.angle;
                while (diff < -Math.PI) diff += Math.PI * 2;
                while (diff > Math.PI) diff -= Math.PI * 2;
                player.angle += diff * currentGrip; 
            }
            socket.emit('update-me', { room: currentRoom, x: player.x, y: player.y, angle: player.angle, num: playerNumber, color: player.color });
            document.getElementById('speed-num').innerText = Math.round(player.speed * 10);
            draw(); 
        }
        requestAnimationFrame(update);
    }

    function playEngineSound(freq) {
        motorOsc = audioCtx.createOscillator(); motorOsc.type = 'sawtooth';
        let gain = audioCtx.createGain(); gain.gain.value = 0.03;
        motorOsc.connect(gain); gain.connect(audioCtx.destination); motorOsc.start();
    }

    function playNitroSound(active) {
        if (active) {
            nitroOsc = audioCtx.createOscillator(); nitroOsc.type = 'square';
            let gain = audioCtx.createGain(); gain.gain.value = 0.02;
            nitroOsc.connect(gain); gain.connect(audioCtx.destination); nitroOsc.start();
        } else if (nitroOsc) { try{nitroOsc.stop();}catch(e){} nitroOsc = null; }
    }

    function draw() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2); ctx.scale(0.5, 0.5); ctx.translate(-player.x, -player.y);
        
        // CIRCUITO CON PIANO ROJO Y BLANCO
        ctx.strokeStyle = "#7a7a7a"; ctx.lineWidth = 850; trackPath(ctx); ctx.stroke();
        ctx.setLineDash([60, 60]); ctx.lineWidth = 625; ctx.strokeStyle = "white"; trackPath(ctx); ctx.stroke();
        ctx.strokeStyle = "#e00000"; ctx.lineDashOffset = 60; trackPath(ctx); ctx.stroke();
        ctx.setLineDash([]); ctx.strokeStyle = "#111111"; ctx.lineWidth = 560; trackPath(ctx); ctx.stroke();
        
        particles.forEach((p, i) => {
            ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
            ctx.fillStyle = p.c; ctx.globalAlpha = p.life; ctx.fill();
            p.life -= 0.05; if(p.life <= 0) particles.splice(i, 1);
        });
        ctx.globalAlpha = 1;
        for(let id in otherPlayers){ drawCar(otherPlayers[id]); }
        drawCar(player);
        ctx.restore();
    }

    function drawCar(p) {
        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.angle);
        ctx.fillStyle = p.color; ctx.fillRect(-55, -28, 110, 56);
        ctx.fillStyle = "black"; ctx.font = "bold 24px Arial"; ctx.textAlign="center"; ctx.fillText(p.num || "?", 0, 10);
        ctx.restore();
    }

    window.onkeydown = e => keys[e.key] = true;
    window.onkeyup = e => keys[e.key] = false;
    update();
</script>
</body>
</html>
