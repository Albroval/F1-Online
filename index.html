<!DOCTYPE html>
<html>
<head>
    <title>F1 Nebula - Sonic Challenge</title>
    <script src="/socket.io/socket.io.js"></script> 
    <style>
        body { margin: 0; overflow: hidden; background: #1a5e1a; font-family: 'Arial Black', sans-serif; }
        canvas { display: block; }
        #overlay { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; }
        button { padding: 20px 40px; font-size: 30px; background: #fbff00; border: none; cursor: pointer; font-family: 'Arial Black'; border-radius: 10px; transition: 0.2s; margin: 10px; }
        button:hover { background: #fffb00; transform: scale(1.05); }
        
        .car-selector { display: flex; gap: 10px; margin: 20px 0; }
        .car-card { 
            background: rgba(255,255,255,0.1); border: 2px solid #555; 
            padding: 10px; border-radius: 8px; cursor: pointer; color: white;
            font-size: 12px; width: 110px; text-align: center; transition: 0.3s;
        }
        .car-card:hover { background: rgba(252, 255, 0, 0.2); }
        .car-card.selected { border-color: #fbff00; background: rgba(252, 255, 0, 0.3); transform: scale(1.05); }
        
        #boost-indicator { position: absolute; top: 150px; left: 20px; color: #fbff00; font-family: 'Courier New'; font-weight: bold; display: none; background: rgba(0,0,0,0.7); padding: 10px; border: 2px solid #fbff00; }
        
        /* ... Estilos anteriores del dashboard y leaderboard se mantienen ... */
        #lights-container { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); display: none; flex-direction: row; background: #222; padding: 10px; border-radius: 10px; z-index: 150; border: 2px solid #444; }
        .light { width: 60px; height: 60px; border-radius: 50%; margin: 5px; background: #111; }
        .red { background: #ff0000; box-shadow: 0 0 30px #ff0000; }
        .yellow { background: #ffcc00; box-shadow: 0 0 30px #ffcc00; }
        .green { background: #00ff00; box-shadow: 0 0 30px #00ff00; }
        #info-panel { position: absolute; top: 20px; left: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        #lap-counter { background: rgba(0,0,0,0.85); color: #fbff00; padding: 15px 25px; border-radius: 10px; border: 2px solid #fbff00; font-size: 20px; font-family: 'Courier New', monospace; }
        #dashboard { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 240px; height: 140px; background: rgba(0,0,0,0.9); border-radius: 120px 120px 15px 15px; border: 4px solid #fbff00; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; padding-bottom: 15px; z-index: 100; }
        #needle { position: absolute; bottom: 50px; width: 4px; height: 90px; background: #ff0000; transform-origin: bottom center; transition: transform 0.1s; }
        #speed-num { color: #fbff00; font-size: 42px; font-weight: bold; font-family: 'Courier New'; }
        #minimap-container { position: absolute; bottom: 25px; left: 25px; width: 280px; height: 200px; background: rgba(0,0,0,0.8); border: 2px solid #fbff00; border-radius: 15px; z-index: 100; }
    </style>
</head>
<body>
    <div id="boost-indicator">BOOST ENTRANDO EN: <span id="boost-timer">3.0</span>s</div>
    
    <div id="overlay">
        <div id="menu-lobby" style="display: flex; flex-direction: column; align-items: center;">
            <h1 style="color: white;">F1 NEBULA</h1>
            <div class="car-selector">
                <div class="car-card selected" onclick="selectCar('balanceado', this)"><h4>NEBULA V1</h4><p>Equilibrado</p></div>
                <div class="car-card" onclick="selectCar('acelerador', this)"><h4>SPRINTER</h4><p>Top 200 / Acel ++</p></div>
                <div class="car-card" onclick="selectCar('offroad', this)"><h4>RALLY</h4><p>Top 200 Césped</p></div>
                <div class="car-card" onclick="selectCar('veloz', this)"><h4>SONIC</h4><p>400km/h (Si eres perfecto)</p></div>
            </div>
            <button onclick="startRaceLocal()">¡EMPEZAR!</button>
        </div>
    </div>

    <div id="info-panel">
        <div id="lap-counter">VUELTA: <span id="lap-num">0</span></div>
    </div>
    <div id="dashboard"><div id="needle"></div><div id="speed-num">0</div></div>
    <canvas id="gameCanvas"></canvas>

<script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let sonicCleanTime = 0; // Tiempo que lleva Sonic sin tocar el césped
    let isSuperSonic = false;

    const CAR_TYPES = {
        balanceado: { top: 35, accel: 1.2, grassMax: 7.2, color: "#fbff00", grip: 0.15 },
        acelerador: { top: 20, accel: 6.0, grassMax: 6.0, color: "#00ccff", grip: 0.15 },
        offroad:    { top: 30, accel: 1.0, grassMax: 20.0, color: "#44ff44", grip: 0.15 },
        veloz:      { top: 30, accel: 0.18, grassMax: 2.0, color: "#4444ff", grip: 0.85 } // Base 300km/h, Césped 20km/h
    };
    
    let selectedCarType = "balanceado";
    let player = { x: 1200, y: 1000, angle: 0, velX: 0, velY: 0, speed: 0, onGrass: false, color: "#fbff00" };
    const keys = {};

    function selectCar(type, element) {
        selectedCarType = type;
        document.querySelectorAll('.car-card').forEach(c => c.classList.remove('selected'));
        element.classList.add('selected');
        player.color = CAR_TYPES[type].color;
    }

    function startRaceLocal() {
        document.getElementById('overlay').style.display = 'none';
        raceStarted = true;
        if(selectedCarType === 'veloz') document.getElementById('boost-indicator').style.display = 'block';
    }

    function trackPath(c, s = 1) {
        const x = 1000*s, y = 1000*s, w = 6000*s, h = 4000*s, r = 800*s;
        c.beginPath(); c.moveTo(x + r, y); c.lineTo(x + w - r, y);
        c.quadraticCurveTo(x + w, y, x + w, y + r); c.lineTo(x + w, y + h - r);
        c.quadraticCurveTo(x + w, y + h, x + w - r, y + h); c.lineTo(x + r, y + h);
        c.quadraticCurveTo(x, y + h, x, y + h - r); c.lineTo(x, y + r);
        c.quadraticCurveTo(x, y, x + r, y); c.closePath();
    }

    function update() {
        if (typeof raceStarted !== 'undefined' && raceStarted) {
            ctx.lineWidth = 600; trackPath(ctx);
            player.onGrass = !ctx.isPointInStroke(player.x, player.y);

            let stats = Object.assign({}, CAR_TYPES[selectedCarType]);
            
            // --- LÓGICA DE SONIC (BOOST & CÉSPED) ---
            if (selectedCarType === 'veloz') {
                if (player.onGrass) {
                    sonicCleanTime = 0;
                    isSuperSonic = false;
                    player.color = "#4444ff"; // Vuelve a azul
                    document.getElementById('boost-timer').innerText = "3.0";
                } else {
                    if (!isSuperSonic) {
                        sonicCleanTime += 1/60; // Asumiendo 60fps
                        let remaining = Math.max(0, 3 - sonicCleanTime);
                        document.getElementById('boost-timer').innerText = remaining.toFixed(1);
                        if (sonicCleanTime >= 3) {
                            isSuperSonic = true;
                            player.color = "#fbff00"; // Se vuelve dorado
                            document.getElementById('boost-timer').innerText = "¡MÁXIMA POTENCIA!";
                        }
                    }
                }
                if (isSuperSonic) stats.top = 40; // Desbloquea los 400km/h
            }

            let inX = 0, inY = 0;
            if (keys['w'] || keys['ArrowUp']) inY -= 1;
            if (keys['s'] || keys['ArrowDown']) inY += 1;
            if (keys['a'] || keys['ArrowLeft']) inX -= 1;
            if (keys['d'] || keys['ArrowRight']) inX += 1;

            if (inX !== 0 || inY !== 0) {
                let mag = Math.sqrt(inX*inX + inY*inY);
                inX /= mag; inY /= mag;
            }

            let targetMax = player.onGrass ? stats.grassMax : stats.top; 
            let frictionBase = (selectedCarType === 'veloz') ? 0.9995 : 0.992;

            if (inX !== 0 || inY !== 0) {
                if (selectedCarType === 'veloz') {
                    let currentSpeed = Math.sqrt(player.velX**2 + player.velY**2);
                    player.velX = (player.velX * 0.5) + (inX * currentSpeed * 0.5);
                    player.velY = (player.velY * 0.5) + (inY * currentSpeed * 0.5);
                }
                player.velX += inX * stats.accel;
                player.velY += inY * stats.accel;
            }

            player.velX *= frictionBase; player.velY *= frictionBase;
            player.speed = Math.sqrt(player.velX**2 + player.velY**2);
            
            if (player.speed > targetMax) {
                player.velX *= (targetMax / player.speed);
                player.velY *= (targetMax / player.speed);
                player.speed = targetMax;
            }

            player.x += player.velX; player.y += player.velY;

            // Rotación suave del coche
            if (player.speed > 0.2) {
                let targetA = Math.atan2(player.velY, player.velX);
                let diff = targetA - player.angle;
                while (diff < -Math.PI) diff += Math.PI * 2;
                while (diff > Math.PI) diff -= Math.PI * 2;
                player.angle += diff * stats.grip; 
            }

            let kmh = Math.round(player.speed * 10);
            document.getElementById('speed-num').innerText = kmh;
            
            draw();
        }
        requestAnimationFrame(update);
    }

    function draw() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2);
        let zoom = 0.6 - (player.speed / 400);
        ctx.scale(zoom, zoom);
        ctx.translate(-player.x, -player.y);

        // Circuito
        ctx.strokeStyle = "#333"; ctx.lineWidth = 800; trackPath(ctx); ctx.stroke();
        ctx.strokeStyle = "#111"; ctx.lineWidth = 560; trackPath(ctx); ctx.stroke();
        
        // Jugador
        ctx.save();
        ctx.translate(player.x, player.y); ctx.rotate(player.angle);
        ctx.fillStyle = player.color;
        ctx.fillRect(-50, -25, 100, 50);
        // Alerón Sonic
        if(isSuperSonic) {
            ctx.strokeStyle = "rgba(255, 255, 255, 0.8)";
            ctx.lineWidth = 5;
            ctx.strokeRect(-55, -30, 110, 60);
        }
        ctx.restore();
        ctx.restore();
    }

    window.onkeydown = e => keys[e.key] = true;
    window.onkeyup = e => keys[e.key] = false;
    update();
</script>
</body>
</html>
