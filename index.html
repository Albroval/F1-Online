<!DOCTYPE html>
<html>
<head>
    <title>F1 NEBULA - ONLINE PRO</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a5e1a; font-family: 'Arial Black', sans-serif; }
        canvas { display: block; }
        
        #overlay {
            position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200;
        }
        button {
            padding: 20px 40px; font-size: 30px; background: #fbff00; border: none; 
            cursor: pointer; font-family: 'Arial Black'; border-radius: 10px; transition: 0.2s;
        }
        button:hover { background: #fffb00; transform: scale(1.05); }

        /* Semáforo */
        #lights-container {
            position: absolute; top: 10%; left: 50%; transform: translateX(-50%);
            display: none; flex-direction: row; background: #222; padding: 10px; border-radius: 10px; z-index: 150; border: 2px solid #444;
        }
        .light { width: 60px; height: 60px; border-radius: 50%; margin: 5px; background: #111; }
        .red { background: #ff0000; box-shadow: 0 0 30px #ff0000; }
        .green { background: #00ff00; box-shadow: 0 0 30px #00ff00; }

        /* HUD */
        #info-panel { position: absolute; top: 20px; left: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        #lap-counter {
            background: rgba(0,0,0,0.85); color: #fbff00;
            padding: 15px 25px; border-radius: 10px; border: 2px solid #fbff00;
            font-size: 20px; font-family: 'Courier New', monospace;
        }
        #leaderboard {
            background: rgba(0,0,0,0.9); border: 2px solid #fbff00;
            border-radius: 10px; padding: 10px; color: white; width: 250px;
        }
        #leaderboard h3 { margin: 0 0 10px 0; font-size: 14px; text-align: center; color: #fbff00; border-bottom: 1px solid #fbff00; padding-bottom: 5px; }
        .record-row { display: flex; justify-content: space-between; font-size: 15px; margin: 6px 0; font-family: 'Courier New'; }

        /* Velocímetro */
        #dashboard {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 240px; height: 140px; background: rgba(0,0,0,0.9);
            border-radius: 120px 120px 15px 15px; border: 4px solid #fbff00;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            padding-bottom: 15px; z-index: 100;
        }
        #needle { position: absolute; bottom: 50px; width: 4px; height: 90px; background: #ff0000; transform-origin: bottom center; transition: transform 0.1s; }
        #speed-num { color: #fbff00; font-size: 42px; font-weight: bold; font-family: 'Courier New'; }
        
        #minimap-container {
            position: absolute; bottom: 25px; left: 25px;
            width: 240px; height: 160px; background: rgba(0,0,0,0.85);
            border: 2px solid #fbff00; border-radius: 15px; z-index: 100; overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="overlay">
        <h1 style="color: white; margin-bottom: 5px;">F1 NEBULA</h1>
        <p id="status-text" style="color: #fbff00; margin-bottom: 25px;">CONECTANDO AL SERVIDOR...</p>
        <button id="start-btn" onclick="requestStart()" style="display:none">ESTOY LISTO</button>
    </div>

    <div id="lights-container">
        <div id="l1" class="light"></div><div id="l2" class="light"></div><div id="l3" class="light"></div><div id="l4" class="light"></div><div id="l5" class="light"></div>
    </div>

    <div id="info-panel">
        <div id="lap-counter">
            <div style="font-size: 14px; color: #aaa; margin-bottom: 5px;">TU DORSAL: #<span id="player-id">?</span></div>
            VUELTA: <span id="lap-num">0</span>
            <div style="font-size: 12px; color: white; margin-top: 5px;">CHECKPOINT: <span id="chk-val" style="color:red">PENDIENTE</span></div>
        </div>
        <div id="leaderboard">
            <h3>CLASIFICACIÓN ONLINE</h3>
            <div id="rank-list"></div>
        </div>
    </div>
    
    <div id="minimap-container"><canvas id="minimapCanvas" width="240" height="160"></canvas></div>
    
    <div id="dashboard">
        <div id="needle" style="transform: rotate(-90deg)"></div>
        <div id="speed-num">0</div>
        <div style="color:white; font-size:12px; letter-spacing: 2px;">KM/H</div>
    </div>
    <canvas id="gameCanvas"></canvas>

<script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const mCanvas = document.getElementById('minimapCanvas');
    const mCtx = mCanvas.getContext('2d');

    let roomId = "PRO-RACE"; // Sala por defecto
    let playerNumber = 0;
    let laps = 0;
    let hasCheckpoint = false;
    let raceStarted = false;
    let canMove = false;
    let players = {};
    let player = { x: 1200, y: 1000, angle: 0, velX: 0, velY: 0, speed: 0, onGrass: false };
    const keys = {};

    // --- CONEXIÓN ---
    socket.on('connect', () => {
        socket.emit('join-room', roomId);
        document.getElementById('status-text').innerText = "SALA: " + roomId;
        document.getElementById('start-btn').style.display = "block";
    });

    socket.on('assign-number', num => {
        playerNumber = num;
        document.getElementById('player-id').innerText = num;
        player.y = 1000 + (num * 100);
    });

    socket.on('update-lobby', data => {
        document.getElementById('status-text').innerText = `PILOTOS: ${data.y} / ${data.x}`;
    });

    function requestStart() {
        socket.emit('player-ready', roomId);
        document.getElementById('start-btn').innerText = "ESPERANDO...";
        document.getElementById('start-btn').disabled = true;
    }

    // --- LÓGICA SEMÁFORO ---
    socket.on('init-race', () => {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('lights-container').style.display = 'flex';
        raceStarted = true;
    });

    socket.on('light', num => {
        document.getElementById('l' + num).classList.add('red');
    });

    socket.on('start-go', () => {
        document.querySelectorAll('.light').forEach(l => {
            l.classList.remove('red');
            l.classList.add('green');
        });
        canMove = true;
        setTimeout(() => document.getElementById('lights-container').style.display = 'none', 2000);
    });

    socket.on('player-moved', data => { players[data.id] = data; });

    socket.on('update-leaderboard', list => {
        list.sort((a,b) => b.laps - a.laps);
        document.getElementById('rank-list').innerHTML = list.map((p, i) => 
            `<div class="record-row ${i==0?'gold':''}">#${p.num} - ${p.laps} VTS</div>`
        ).join('');
    });

    // --- BUCLE DE JUEGO ---
    function trackPath(c, s = 1) {
        const x = 1000*s, y = 1000*s, w = 6000*s, h = 4000*s, r = 800*s;
        c.beginPath();
        c.moveTo(x + r, y); c.lineTo(x + w - r, y);
        c.quadraticCurveTo(x + w, y, x + w, y + r); c.lineTo(x + w, y + h - r);
        c.quadraticCurveTo(x + w, y + h, x + w - r, y + h); c.lineTo(x + r, y + h);
        c.quadraticCurveTo(x, y + h, x, y + h - r); c.lineTo(x, y + r);
        c.quadraticCurveTo(x, y, x + r, y); c.closePath();
    }

    function update() {
        if (raceStarted && canMove) {
            let inX = 0, inY = 0;
            if (keys['w'] || keys['W']) inY -= 1;
            if (keys['s'] || keys['S']) inY += 1;
            if (keys['a'] || keys['A']) inX -= 1;
            if (keys['d'] || keys['D']) inX += 1;

            if (inX !== 0 || inY !== 0) {
                let mag = Math.sqrt(inX*inX + inY*inY);
                inX /= mag; inY /= mag;
            }

            // Inercia y Superficie
            let targetMax = player.onGrass ? 10 : 35;
            let accel = player.onGrass ? 0.2 : (player.speed < 32 ? 1.2 : 0.1);
            
            player.velX += inX * accel;
            player.velY += inY * accel;
            player.velX *= 0.97;
            player.velY *= 0.97;

            player.speed = Math.sqrt(player.velX**2 + player.velY**2);
            if (player.speed > targetMax) {
                player.velX *= (targetMax / player.speed);
                player.velY *= (targetMax / player.speed);
            }

            player.x += player.velX;
            player.y += player.velY;

            // Checkpoint y Meta
            if (!hasCheckpoint && player.x > 6000 && player.y > 4000) {
                hasCheckpoint = true;
                document.getElementById('chk-val').innerText = "OK";
                document.getElementById('chk-val').style.color = "#00ff00";
            }
            if (hasCheckpoint && player.x > 1400 && player.x < 1550 && player.y < 1600) {
                laps++;
                document.getElementById('lap-num').innerText = laps;
                hasCheckpoint = false;
                document.getElementById('chk-val').innerText = "PENDIENTE";
                document.getElementById('chk-val').style.color = "red";
                socket.emit('lap-completed', { roomId });
            }

            // Ángulo de animación suave
            if (player.speed > 0.5) {
                let targetA = Math.atan2(player.velY, player.velX);
                let diff = targetA - player.angle;
                while (diff < -Math.PI) diff += Math.PI * 2;
                while (diff > Math.PI) diff -= Math.PI * 2;
                player.angle += diff * 0.2;
            }

            // Velocímetro
            let kmh = Math.round(player.speed * 10);
            document.getElementById('speed-num').innerText = kmh;
            document.getElementById('needle').style.transform = `rotate(${-90 + (kmh * 0.51)}deg)`;

            socket.emit('move', { roomId, id: socket.id, x: player.x, y: player.y, angle: player.angle, num: playerNumber });
        }
        draw();
        requestAnimationFrame(update);
    }

    function draw() {
        ctx.fillStyle = "#1a5e1a"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        let zoom = 0.5 - (player.speed / 150);
        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.scale(zoom, zoom);
        ctx.translate(-player.x, -player.y);

        // Dibujar Pista
        ctx.strokeStyle = "#555"; ctx.lineWidth = 950; trackPath(ctx); ctx.stroke(); // Escapatoria
        ctx.setLineDash([60, 60]);
        ctx.lineWidth = 650; ctx.strokeStyle = "white"; trackPath(ctx); ctx.stroke(); // Piano blanco
        ctx.strokeStyle = "#e11"; ctx.lineDashOffset = 60; trackPath(ctx); ctx.stroke(); // Piano rojo
        ctx.setLineDash([]);
        ctx.strokeStyle = "#111"; ctx.lineWidth = 580; trackPath(ctx); ctx.stroke(); // Asfalto
        
        // Línea Meta
        ctx.fillStyle = "white"; ctx.fillRect(1400, 720, 150, 580);

        // Otros Jugadores
        for(let id in players) {
            let p = players[id];
            drawCar(p.x, p.y, p.angle, p.num, "#ff4444");
        }
        // Mi Coche
        drawCar(player.x, player.y, player.angle, playerNumber, "#fbff00");

        ctx.restore();

        // Detección de Hierba (usando la misma ruta de la pista)
        const trackRegion = new Path2D(); trackPath(trackRegion);
        ctx.lineWidth = 600;
        player.onGrass = !ctx.isPointInStroke(trackRegion, player.x, player.y);
        
        drawMinimap();
    }

    function drawCar(x, y, ang, num, color) {
        ctx.save();
        ctx.translate(x, y); ctx.rotate(ang);
        ctx.fillStyle = color; ctx.fillRect(-55, -28, 110, 56);
        ctx.fillStyle = "black"; ctx.fillRect(20, -32, 20, 64); // Alerón
        ctx.fillStyle = "black"; ctx.font = "bold 26px Arial"; ctx.textAlign="center"; ctx.fillText(num, -20, 10);
        ctx.restore();
    }

    function drawMinimap() {
        mCtx.clearRect(0,0, mCanvas.width, mCanvas.height);
        let s = 0.03;
        mCtx.save(); mCtx.translate(20, 20);
        mCtx.strokeStyle = "rgba(255,255,255,0.4)"; mCtx.lineWidth = 2;
        trackPath(mCtx, s); mCtx.stroke();
        
        // Rivales
        mCtx.fillStyle = "red";
        for(let id in players) { mCtx.beginPath(); mCtx.arc(players[id].x*s, players[id].y*s, 3, 0, Math.PI*2); mCtx.fill(); }
        // Yo
        mCtx.fillStyle = "#fbff00";
        mCtx.beginPath(); mCtx.arc(player.x*s, player.y*s, 5, 0, Math.PI*2); mCtx.fill();
        mCtx.restore();
    }

    window.onkeydown = e => keys[e.key] = true;
    window.onkeyup = e => keys[e.key] = false;
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();
    update();
</script>
</body>
</html>
